<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="//directdemocracy.vote/favicon.ico">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <link rel="stylesheet" href="css/croppie.css">
    <link rel="stylesheet" href="css/directdemocracy.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="//unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="js/croppie.min.js"></script>
    <script src="js/jsencrypt.min.js"></script>
    <script src="js/crypto-js.js"></script>
    <script>
      var card = {
        schema: "https://directdemocracy.vote/json-schema/0.0.1/card.schema.json",
        key:"",
        signature:"",
        published:"",
        expires:"",
        familyName:"",
        givenNames:"",
        picture:"",
        latitude:0,
        longitude:0
      };
var validate = function() {
  var button = document.getElementById("publish-button");
  if (button)
    button.setAttribute("disabled", "disabled");
  if (card.key === '' || card.picture === '')
    return;
  if (card.latitude === 0 && card.longitude === 0)
    return;
  card.familyName = document.getElementById("family-name").value;
  if (card.familyName === '')
    return;
  card.givenNames = document.getElementById("given-names").value;
  if (card.givenNames === '')
    return;
  if (!document.getElementById("confirm-check").checked)
    return;
  button.removeAttribute("disabled");
}
var publish = function() {
  d = new Date();
  card.published = d.toISOString();
  d.setFullYear(d.getFullYear() + 10);
  card.expires = d.toISOString();
  card.signature = "";
  var str = JSON.stringify(card);
  card.signature = crypt.sign(str, CryptoJS.SHA256, "sha256");
  console.log("signed string: " + str);
  var xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    if (this.status == 200) {
      console.log(this.responseText);
    }
  };
  xhttp.open("POST", "https://publisher.directdemocracy.vote/publish.php", true);
  xhttp.send(JSON.stringify(card));
  console.log(card.key);
  return false;
}
var dt = new Date();
var time = -(dt.getTime());
var crypt = new JSEncrypt({default_key_size: 2048});
crypt.getKey(function() {
  dt = new Date();
  time += (dt.getTime());
  card.key = crypt.getPublicKey();
  console.log(crypt.getPrivateKey());
  localStorage.setItem("privateKey", crypt.getPrivateKey());
  document.getElementById("forging-spinner").style.display = 'none';
  document.getElementById("private-key-icon").style.display = '';
  document.getElementById("private-key-message").innerHTML = "You new private key was just forged in " + Number(time / 1000).toFixed(2) + " seconds.";
  validate();
});
var croppie = null;
var onUploadClick = function() {
var upload = document.getElementById("picture-upload");
  upload.click();
}
var onPictureUploaded = function(event) {
  if (croppie)
  croppie.destroy();
  var img = document.getElementById("picture-display");
  img.src = URL.createObjectURL(event.target.files[0]);
  event.target.value = '';
  croppie = new Croppie(img, {boundary: {width:250, height: 300}, viewport: {width:150, height: 200}, enableExif: true});
  document.getElementById("picture-select").style.display = "";
}
var onPictureSelect = function() {
  croppie.result({type:'base64', format: 'jpeg', quality: 0.95}).then(function(result) {
    var img = document.getElementById("picture-display");
    img.setAttribute('src', result);
    card.picture = result;
    document.getElementById("picture-select").style.display = "none";
    croppie.destroy();
    croppie = null;
    validate();
  });
}
    </script>
    <title>directdemocracy.vote</title>
  </head>

  <body>
    <div class="modal" id="myModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Be patient...</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">As of August 29th, 2019, this is not yet implemented... But we are working hard on it. Please come back later.</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class='corner-ribbon' title="This web site is in beta quality: it may have bugs and change without notice. Please, report any problem to info@<?=$base_domain?>.">Beta</div>
    <main role='main'>
      <div class="jumbotron directdemocracy-title">
        <div class="container">
          <div class="row" style="margin-top:30px;margin-bottom:30px">
            <div class="col-sd-1" style="margin-right:20px;margin-top:10px"><img class="directdemocracy-title-logo" src="images/directdemocracy-title.png"></div>
            <div class="col-sd-11">
              <h1><b>direct</b>democracy</h1>
              <div style="font-size:150%">let's make a better world</div>
            </div>
          </div>
          <div class="directdemocracy-subtitle" style="position:relative;top:0;margin-bottom:40px">
            <h3>- Vote and propose referendums online</h3>
            <h3>- Push governments to respect people's will</h3>
            <h3>- Spread peace and prosperity worldwide</h3>
          </div>
          <div style="padding-bottom:40px"><button class="btn btn-success" role="button" data-toggle="modal" data-target="#myModal">Become a Citizen &raquo;</button></div>
        </div>
      </div>
      <div class="container">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link active" data-toggle="tab" href="#register">Register</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#privacy">Privacy</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#about">About</a>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane container active" id="register"><br>
            <div class="form-group">
              <label for="family-name">Family name:</label>
              <input type="text" class="form-control" id="family-name" placeholder="Enter your family name here" oninput="validate()">
            </div>
            <div class="form-group">
              <label for="given-names">Given name(s):</label>
              <input type="text" class="form-control" id="given-names" placeholder="Enter your given name(s) here." oninput="validate()">
              <small class="form-text text-muted">Include your middle name(s) only if that helps distinguishing you from someone else at the same home address.</small>
            </div>
            <div class="form-group">
              <label for="picture">Picture:</label>
              <input type="file" style="display:none" class="custom-file-input" id="picture-upload" accept="image/*" onchange="onPictureUploaded(event)">
              <div class="container">
                <div class="row">
                  <div class="col-md-6">
                    <img id="picture-display" src="images/default-picture.png" style="width:150px;margin: 0px 50px 0px 50px;" onclick="onUploadClick()">
                  </div>
                  <div class="col-md-6 input-group-vertical" role="group" style="margin-top:10px">
                    <button class="btn btn-secondary" onclick="onUploadClick(); return false;">Upload</button>
                    <button class="btn btn-secondary" id="picture-select" style="display:none" onclick="onPictureSelect(); return false;">Select</button>
                    <small class="form-text text-muted">You need a clear, recognizable identity picture of yourself.</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="container">
                <div class="row">
                  <div class="col-md-2">
                    <label for "latitude">Latitude:</label>
                    <input type="text" readonly class="form-control" id="latitude">
                  </div>
                  <div class="col-md-2">
                    <label for "longitude">Longitude:</label>
                    <input type="text" readonly class="form-control" id="longitude">
                  </div>
                  <div class="col-md-8">
                    <label for "address">Address:</label>
                    <div class="form-text text-muted" id="address" style="vertical-align:bottom"></div>
                  </div>
                </div>
                <small class="form-text text-muted">Select your home address very precisely on the map to display your exact latitude and longitude coordinates.</small>
                <div id="latlongmap" style="width:100%;height:400px;margin-top:10px"></div>
                <script type="text/javascript">
                  var geolocation = false;
                  card.latitude = 0;
                  card.longitude = 0;
                  if (navigator.geolocation) navigator.geolocation.getCurrentPosition(getGeolocationPosition);
                  var xhttp = new XMLHttpRequest();
                  xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200 && geolocation == false) {
                      coords = this.responseText.split(',');
                      getGeolocationPosition({
                        coords: {
                          latitude: coords[0],
                          longitude: coords[1]
                        }
                      });
                    }
                  };
                  xhttp.open("GET", "https://ipinfo.io/loc", true);
                  xhttp.send();

                  function getGeolocationPosition(position) {
                    geolocation = true;
                    card.latitude = Math.round(1000000 * position.coords.latitude);
                    card.longitude = Math.round(1000000 * position.coords.longitude);
                    mymap.setView([position.coords.latitude, position.coords.longitude], 12);
                    setTimeout(updateMarker, 500);
                  }

                  function updateMarker() {
                    mmr.setLatLng([card.latitude / 1000000, card.longitude / 1000000]);
                    setui(12);
                  }
                  var lat = card.latitude / 1000000;
                  var lon = card.longitude / 1000000;
                  var mymap = L.map('latlongmap').setView([lat, lon], 2);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                  }).addTo(mymap);
                  var mmr = L.marker([lat, lon]).addTo(mymap).bindPopup(lat + ',' + lon);
                  setui(12);
                  mymap.on('click', onMapClick);

                  function onMapClick(e) {
                    mmr.setLatLng(e.latlng);
                    card.latitude = Math.round(1000000 * e.latlng.lat);
                    card.longitude = Math.round(1000000 * e.latlng.lng);
                    setui(mymap.getZoom());
                  }

                  function setui(zm) {
                    var lat = card.latitude / 1000000;
                    var lon = card.longitude / 1000000;
                    mmr.setPopupContent(lat + ',' + lon).openPopup();
                    document.getElementById("latitude").value = lat;
                    document.getElementById("longitude").value = lon;
                    validate();
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                      if (this.readyState == 4 && this.status == 200) {
                        a = JSON.parse(this.responseText);
                        mmr.setPopupContent(a.address.Match_addr + '<br><br><center style="color:#999">(' + lat + ', ' + lon + ')</center>').openPopup();
                        document.getElementById("address").innerHTML = a.address.Match_addr;
                      }
                    };
                    xhttp.open("GET", "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=json&featureTypes=&location=" + lon + "," + lat, true);
                    xhttp.send();
                  }

                </script>
              </div>
            </div>
            <div class="form-group">
              <label for="private-key">Private key: &nbsp; <img id="private-key-icon" src="images/key.svg" style="display:none;width:32px">
                <div id="forging-spinner" class="spinner-border" role="status"><span class="sr-only">Forging...</span></div>
              </label>
              <input type="hidden" class="form-control" id="private-key">
              <small class="form-text text-muted" id="private-key-message">Forging a new private key, please wait...</small>
            </div>
            <div class="form-group">
              <label for="validity">Validity: 10 years.</label>
              <small class="form-text text-muted">May be revokey before if needed.</small>
            </div>
            <div class="form-group"><br>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="confirm-check" onchange="validate()">
                <label class="form-check-label" for="confirm-check"> I confirm the above information is correct.</label><br>
              </div><br>
              <button class="btn btn-success" id="publish-button" role="button" disabled="disabled" onclick="publish();">Publish your citizen card</button>
              <small class="form-text text-muted">Warning: this cannot be undone!</small>
            </div>
          </div>
          <div class="tab-pane container fade" id="privacy"><br>
            <div class="row">
              <div class="col-md-6">
                <h2>Personal Data</h2>
                <p>This website use no cookie to store any private data and will never ask your e-mail address. However, becoming a citizen implies publishing a citizen card that includes your name, picture and GPS home address. This information
                  will be made fully public and displayed on other websites. This website will not store any other information about you. In particular it has no access to your private key or your password (used to encrypt your private key).</p>
              </div>
              <div class="col-md-6">
                <h2>Private Key</h2>
                <p>In <em>directdemocracy</em>, each citizen has a private key. This is a file that contains your personnal cryptographic information. It allows you to vote and perform other operations involving electronic signature. It is created
                  during the registration process and stored only on the phone or computer used for registering. You can however export this file to a different phone or computer. Beware to keep this file strictly confidential. If someone else could
                  access this file and your password, this person would be able to usurpate your identity, vote for you and sign documents for you.</p>
              </div>
            </div>
          </div>
          <div class="tab-pane container fade" id="about"><br>
            <div class="row">
              <div class="col-md-4">
                <h2>Vision</h2>
                <p>This initiative aims at establishing world-wide <a href="https://en.wikipedia.org/wiki/Direct_democracy" target="_blank">direct democracy</a> in order to bring peace, safety and prosperity to humananity, including saving the
                  climate and the biodiversity. The principle is that people will become citizens by proposing referundums and voting regardless of any official acknowledgement. Vote results from a limited number of citizens could be considered as
                  simple survey results. They could feed debates, influence political decisions and foster more people to become citizens. Vote results from areas where a majority of people are citizens will become significant from a democratic
                  point of view. This will increase the pressure on governments to respect the democratic choices expressed by their people. Ultimately, this bottom-up initiative will enforce direct democracy everywhere in the world.</p>
              </div>
              <div class="col-md-4">
                <h2>Features</h2>
                <p>The proposed system implements the following necessary features:</p>
                <ul>
                  <li>open to anybody with internet access from a smartphone or a computer.</li>
                  <li>allowing anybody to propose referendums.</li>
                  <li>fully decentralized: nobody can control it.</li>
                  <li>supported by a <a href="https://en.wikipedia.org/wiki/Web_of_trust" target="_blank">web of trust</a>: distributed reputation system.</li>
                  <li>verifiable: check that my vote was taken into account, check that others didn't cheat.</li>
                  <li>robust to attacks, resistant to censorship.</li>
                  <li>relying on state-of-the-art <a href="https://en.wikipedia.org/wiki/Cryptography" target="_blank">cryptography</a>, <a href="https://en.wikipedia.org/wiki/Free_and_open-source_software" target="_blank">free and open-source</a>
                    specifications and implementations.</li>
                  <li>providing easy-to-use user interfaces.</li>
                  <li>aimed at gaining confidence of both technical and non-technical people.</li>
                </ul>
              </div>
              <div class="col-md-4">
                <h2>Contribute</h2>
                <p>Because the system is fully decentralized, you can become any kind of these participants:</p>
                <ul>
                  <li><b>citizen</b>: anybody with internet access.</li>
                  <li><b>truster</b>: any computer scientist with computer network resources.</li>
                  <li><b>station</b>: (polling station) any computer scientist with computer network resources.</li>
                  <li><b>publisher</b>: any computer scientist with computer network resources.</li>
                </ul>
                <p>We also accept donations to support our effort. More information about this will come later.</p>
                <p><a class="btn btn-secondary" href="https://github.com/directdemocracy-vote/doc" target="_blank" role="button">View technical details &raquo;</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div>
      <hr>
      <footer>
        <p style='text-align:center'><small>Made by citizens for citizens</small></p>
      </footer>
    </div>
  </body>

</html>
