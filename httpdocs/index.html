<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="//directdemocracy.vote/favicon.ico">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <link rel="stylesheet" href="css/croppie.css">
    <link rel="stylesheet" href="css/directdemocracy.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="//unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="js/croppie.min.js"></script>
    <script src="js/jsencrypt.min.js"></script>
    <script src="js/crypto-js.js"></script>
    <script src="js/qrious.min.js"></script>
    <title>directdemocracy.vote</title>
  </head>

  <body>
    <div class="modal" id="modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="modal-title">Title</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body" id="modal-contents">Contents</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="modal-close-button">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modal-revoke">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Revoke your Private Key</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <div>You should revoke your private key only if you believe someone else could have accessed it and may be in position to usurpate your citizen indentity.</div><br>
            <div>The consequence of revoking your private key is that all your publications and some other publications will be revoked, including:</div><br>
            <ul>
              <li>Your citizen card.</li>
              <li>Your endorsements.</li>
              <li>The endorsements you received from other citizens.</li>
            </ul>
            <div>You will have to create a new citizen card, re-endorse and get endorsed by other citizens.</div><br>
            <div class="form-group">
              <label class="form-control-label">
                <div>If you are sure to understand the consequences of revoking your private key, please type "<b>I understand</b>" here:</div><br>
                <input id="revoke-i-understand" oninput="updateRevokeButton();" type="text" class="form-control" placeholder="">
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="revoke-button" class="btn btn-danger" disabled="disabled" onclick="revokePrivateKey();">Revoke Private Key</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modal-edit">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Edit your Citizen Card</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <div>You should edit your citizen card only if you move or change your name.</div><br>
            <div>The consequence of editing your citizen card is that all the endorsements of your citizen card will be revoked and you will have to ask others to endorse your new citizen card.</div><br>
            <div class="form-group">
              <label class="form-control-label">
                <div>If you are sure to understand the consequences of editing your citizen card, please type "<b>I understand</b>" here:</div><br>
                <input id="edit-i-understand" oninput="updateEditButton();" type="text" class="form-control" placeholder="">
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="edit-button" class="btn btn-danger" disabled="disabled" onclick="editCitizenCard();">Edit Citizen Card</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div class='corner-ribbon' title="This web site is in beta quality: it may have bugs and change without notice. Please, report any problem to info@<?=$base_domain?>.">Beta</div>
    <main role='main'>
      <div class="jumbotron directdemocracy-title">
        <div class="container">
          <div class="row" style="margin-top:30px;margin-bottom:30px">
            <div class="col-sd-1" style="margin-right:20px;margin-top:10px"><img class="directdemocracy-title-logo" src="images/directdemocracy-title.png"></div>
            <div class="col-sd-11">
              <h1><b>direct</b>democracy</h1>
              <div style="font-size:150%">let's make a better world</div>
            </div>
          </div>
          <div class="directdemocracy-subtitle" style="position:relative;top:0;margin-bottom:40px">
            <h3>- Vote and propose referendums online</h3>
            <h3>- Push governments to respect people's will</h3>
            <h3>- Spread peace and prosperity worldwide</h3>
          </div>
          <div style="padding-bottom:40px"><a class="btn btn-success" role="button" href="#register">Become a Citizen</a></div>
        </div>
      </div>
      <div class="container">
        <ul class="nav nav-tabs">
          <li class="nav-item" id="register-nav">
            <a class="nav-link" id="register-nav-link" data-toggle="tab" href="#register">Register</a>
          </li>
          <li class="nav-item" id="citizen-nav">
            <a class="nav-link" id="citizen-nav-link" data-toggle="tab" href="#citizen">Citizen Card</a>
          </li>
          <li class="nav-item" id="endorsements-nav">
            <a class="nav-link" id="endorsements-nav-link" data-toggle="tab" href="#endorsements">Endorsements</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#settings">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#privacy">Privacy</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#about">About</a>
          </li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane container active" id="register"><br>
            <div class="form-group">
              <label for="picture">Picture:</label>
              <input type="file" style="display:none" class="custom-file-input" id="picture-upload" accept="image/*" onchange="onPictureUploaded(event)" required>
              <div class="container">
                <div class="row">
                  <div class="col-md-6">
                    <img id="picture-display" src="images/default-picture.png" style="width:150px;margin: 0px 50px 0px 50px;" onclick="onUploadClick()">
                  </div>
                  <div class="col-md-6 input-group-vertical" role="group" style="margin-top:10px">
                    <button class="btn btn-secondary" onclick="onUploadClick(); return false;">Upload</button>
                    <button class="btn btn-secondary" id="picture-select" style="display:none" onclick="onPictureSelect(); return false;">Select</button>
                    <small class="form-text text-muted">You need a clear, recognizable identity picture of yourself.</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="family-name">Family name:</label>
              <input type="text" class="form-control" id="family-name" placeholder="Enter your family name here" oninput="validate()" required>
            </div>
            <div class="form-group">
              <label for="given-names">Given name(s):</label>
              <input type="text" class="form-control" id="given-names" placeholder="Enter your given name(s) here." oninput="validate()" required>
              <small class="form-text text-muted">Include your middle name(s) only if that helps distinguishing you from someone else at the same home address.</small>
            </div>
            <div class="form-group">
              <div class="container">
                <div class="row">
                  <div class="col-md-2">
                    <label for "latitude">Latitude:</label>
                    <input type="text" readonly class="form-control" id="latitude" required>
                  </div>
                  <div class="col-md-2">
                    <label for "longitude">Longitude:</label>
                    <input type="text" readonly class="form-control" id="longitude" required>
                  </div>
                  <div class="col-md-8">
                    <label for "address">Address:</label>
                    <div class="form-text text-muted" id="address" style="vertical-align:bottom"></div>
                  </div>
                </div>
                <small class="form-text text-muted">Select your home address very precisely on the map to display your exact latitude and longitude coordinates.</small>
                <div id="latlongmap" style="width:100%;height:400px;margin-top:10px"></div>
              </div>
            </div>
            <div class="form-group">
              <label for="private-key">Private key: &nbsp; <img id="private-key-icon" src="images/key.svg" style="display:none;width:32px">
                <div id="forging-spinner" class="spinner-border" role="status"><span class="sr-only">Forging...</span></div>
              </label>
              <input type="hidden" class="form-control" id="private-key">
              <small class="form-text text-muted" id="private-key-message">Forging a new private key, please wait...</small>
            </div>
            <div class="form-group">
              <label for="expiration">Expiration:</label>
              <input class="form-control" type="date" value="2000-01-01" id="expiration" required oninput="validate();">
              <div class="invalid-feedback">Select an expiration date between today and 10 years from now.</div>
              <small class="form-text text-muted">Leave it to 10 years unless you anticipate any ealier change (move or name change).</small>
            </div>
            <div class="form-group"><br>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="confirm-check" onchange="validate()">
                <label class="form-check-label" for="confirm-check">I confirm I am over 18 years old and the above information is correct.</label><br>
              </div><br>
              <button class="btn btn-success" id="publish-button" role="button" disabled="disabled" onclick="publish();">Publish your citizen card</button>
              <small class="form-text text-muted">Warning: this cannot be undone!</small>
            </div>
          </div>
          <div class="tab-pane container fade" id="citizen"><br>
            <div class="row">
              <div class="col-md-4" style="max-width:170px">
                <img id="citizen-picture" src="images/default-picture.png" style="width:150px;height:200px">
              </div>
              <div class="col-md-4">
                <div class="citizen-label"> Family name: </div>
                <div id="citizen-family-name" class="citizen-entry"> </div>
                <div class="citizen-label"> Given names: </div>
                <div id="citizen-given-names" class="citizen-entry"> </div>
                <div class="citizen-label"> Latitude, longitude: </div>
                <div id="citizen-coords" class="citizen-entry"> 0, 0 </div>
                <div class="citizen-label">
                  <div class="row">
                    <div class="col-md-4">Created:</div>
                    <div id="citizen-published" class="col-md-1 citizen-date">0000-00-00</div>
                  </div>
                  <div class="row">
                    <div class="col-md-4">Valid until:</div>
                    <div id="citizen-expires" class="col-md-1 citizen-date">0000-00-00</div>
                  </div>
                </div>
              </div>
              <div class="col-md-4" style="max-width:220px">
                <canvas id="citizen-qr-code" width="200" height="200" style="border:1px solid">
              </div>
            </div>
          </div>
          <div class="tab-pane container fade" id="endorsements"><br>
            <div class="form-group">
              <button id="endorse" class="btn btn-primary" onclick="endorse()">Endorse a Citizen</button>
              <small class="form-text text-muted">Scan the QR code of another citizen's card to endorse her.</small>
            </div>
          </div>
          <div class="tab-pane container fade" id="settings"><br>
            <div class="form-group"><br>
              <label for="publisher">Publisher URL:</label>
              <input type="url" class="form-control" id="publisher" placeholder="Enter your publisher here" required oninput="updatePublisher()">
              <small class="form-text text-muted">Do not change this unless you know what you are doing.</small>
            </div>
            <div class="form-group"><br>
              <button id="edit" class="btn btn-danger" onclick="edit()">Edit my citizen card</button>
              <small class="form-text text-muted">If you move or change your name, you should edit your citizen card.</small>
            </div>
            <div class="form-group"><br>
              <button id="revoke" class="btn btn-danger" onclick="revoke()">Revoke my private key</button>
              <small class="form-text text-muted">If you believe your private key was compromised, you should revoke it.</small>
            </div>
          </div>
          <div class="tab-pane container fade" id="privacy"><br>
            <div class="row">
              <div class="col-md-6">
                <h2>Personal Data</h2>
                <p>This website use no cookie to store any private data and will never ask your e-mail address. However, becoming a citizen implies publishing a citizen card that includes your name, picture and GPS home address. This information
                  will be made fully public and displayed on other websites. This website will not store any other information about you. In particular it has no access to your private key or your password (used to encrypt your private key).</p>
              </div>
              <div class="col-md-6">
                <h2>Private Key</h2>
                <p>In <em>directdemocracy</em>, each citizen has a private key. This is a file that contains your personnal cryptographic information. It allows you to vote and perform other operations involving electronic signature. It is created
                  during the registration process and stored only on the phone or computer used for registering. You can however export this file to a different phone or computer. Beware to keep this file strictly confidential. If someone else could
                  access this file and your password, this person would be able to usurpate your identity, vote for you and sign documents for you.</p>
              </div>
            </div>
          </div>
          <div class="tab-pane container fade" id="about"><br>
            <div class="row">
              <div class="col-md-4">
                <h2>Vision</h2>
                <p>This initiative aims at establishing world-wide <a href="https://en.wikipedia.org/wiki/Direct_democracy" target="_blank">direct democracy</a> in order to bring peace, safety and prosperity to humananity, including saving the
                  climate and the biodiversity. The principle is that people will become citizens by proposing referundums and voting regardless of any official acknowledgement. Vote results from a limited number of citizens could be considered as
                  simple survey results. They could feed debates, influence political decisions and foster more people to become citizens. Vote results from areas where a majority of people are citizens will become significant from a democratic
                  point of view. This will increase the pressure on governments to respect the democratic choices expressed by their people. Ultimately, this bottom-up initiative will enforce direct democracy everywhere in the world.</p>
              </div>
              <div class="col-md-4">
                <h2>Features</h2>
                <p>The proposed system implements the following necessary features:</p>
                <ul>
                  <li>open to anybody with internet access from a smartphone or a computer.</li>
                  <li>allowing anybody to propose referendums.</li>
                  <li>fully decentralized: nobody can control it.</li>
                  <li>supported by a <a href="https://en.wikipedia.org/wiki/Web_of_trust" target="_blank">web of trust</a>: distributed reputation system.</li>
                  <li>verifiable: check that my vote was taken into account, check that others didn't cheat.</li>
                  <li>robust to attacks, resistant to censorship.</li>
                  <li>relying on state-of-the-art <a href="https://en.wikipedia.org/wiki/Cryptography" target="_blank">cryptography</a>, <a href="https://en.wikipedia.org/wiki/Free_and_open-source_software" target="_blank">free and open-source</a>
                    specifications and implementations.</li>
                  <li>providing easy-to-use user interfaces.</li>
                  <li>aimed at gaining confidence of both technical and non-technical people.</li>
                </ul>
              </div>
              <div class="col-md-4">
                <h2>Contribute</h2>
                <p>Because the system is fully decentralized, you can become any kind of these participants:</p>
                <ul>
                  <li><b>citizen</b>: anybody with internet access.</li>
                  <li><b>trustee</b>: any computer scientist with computer network resources.</li>
                  <li><b>station</b>: (polling station) any computer scientist with computer network resources.</li>
                  <li><b>publisher</b>: any computer scientist with computer network resources.</li>
                </ul>
                <p>We also accept donations to support our effort. More information about this will come later.</p>
                <p><a class="btn btn-secondary" href="https://github.com/directdemocracy-vote/doc" target="_blank" role="button">View technical details &raquo;</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div>
      <hr>
      <footer>
        <p style='text-align:center'><small>Made by citizens for citizens</small></p>
      </footer>
    </div>
    <script type="text/javascript">
      var croppie = null;
      var geolocation = false;
      var citizen = null;
      var map = null;
      var marker = null;
      var crypt = null;
      var privateKey = '';
      var publisher = '';

      function endorse() {
        console.log("Endorse");
      }

      function checkExpirationValidity() {
        var expiration = document.getElementById("expiration");
        var choice = new Date(expiration.value + 'T00:00:00Z');
        var min = new Date();
        var max = new Date();
        max.setFullYear(max.getFullYear() + 10);
        if (choice > max || choice < min) {
          expiration.setCustomValidity("Please enter a date between tomorrow and 10 year from now.");
          return false;
        }
        expiration.setCustomValidity("");
        return true;
      }

      function updateCitizenCard() {
        document.getElementById('citizen-picture').setAttribute('src', citizen.picture);
        document.getElementById('citizen-family-name').innerHTML = citizen.familyName;
        document.getElementById('citizen-given-names').innerHTML = citizen.givenNames;
        document.getElementById('citizen-coords').innerHTML = "<a target='_blank' href='https://openstreetmap.org/?mlat=" + +citizen.latitude / 1000000 + "&mlon=" + citizen.longitude / 1000000 + "&zoom=12'>" + +citizen.latitude / 1000000 + ", " +
          citizen.longitude / 1000000 + "</a>";
        document.getElementById('citizen-published').innerHTML = citizen.published.substring(0, 10);
        document.getElementById('citizen-expires').innerHTML = citizen.expires.substring(0, 10);
        var fingerprint = CryptoJS.SHA1(citizen.key).toString();
        var qr = new QRious({
          element: document.getElementById('citizen-qr-code'),
          value: fingerprint,
          level: 'M',
          size: 200,
          padding: 13
        })
      }

      function updateRegistrationForm() {
        document.getElementById('picture-display').src = citizen.picture;
        document.getElementById('family-name').value = citizen.familyName;
        document.getElementById('given-names').value = citizen.givenNames;
        document.getElementById('latitude').value = citizen.latitude;
        document.getElementById('longitude').value = citizen.longitude;
      }

      function validate() {
        var button = document.getElementById("publish-button");
        button.setAttribute("disabled", "disabled");
        if (citizen.key === '' || citizen.picture === '') return;
        if (citizen.latitude === 0 && citizen.longitude === 0) return;
        citizen.familyName = document.getElementById("family-name").value;
        if (citizen.familyName === '') return;
        citizen.givenNames = document.getElementById("given-names").value;
        if (citizen.givenNames === '') return;
        if (!document.getElementById("confirm-check").checked) return;
        if (!checkExpirationValidity()) return;
        button.removeAttribute("disabled");
      }

      function showModal(title, contents) {
        document.getElementById('modal-title').innerHTML = title;
        document.getElementById('modal-contents').innerHTML = contents;
        $('#modal').modal();
      }

      function updatePublisher() {
        publisher = document.getElementById("publisher").value;
        localStorage.setItem("publisher", publisher);
      }

      function publish() {
        d = new Date();
        citizen.published = d.toISOString();
        d.setFullYear(d.getFullYear() + 10);
        d = new Date(document.getElementById("expiration").value + "T00:00:00Z");
        citizen.expires = d.toISOString();
        citizen.signature = '';
        var str = JSON.stringify(citizen);
        citizen.signature = crypt.sign(str, CryptoJS.SHA256, "sha256");
        var xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
          if (this.status == 200) {
            answer = JSON.parse(this.responseText);
            if (answer.error) {
              showModal("Publication error", JSON.stringify(answer.error) + ".<br>Please try again.");
            } else {
              localStorage.setItem("publication", publisher + "/publication.php?id=" + answer.citizen);
              localStorage.setItem("citizen", JSON.stringify(citizen));
              localStorage.setItem("privateKey", privateKey);
              updateCitizenCard();
              document.getElementById('citizen-nav-link').style.display = '';
              document.getElementById('register-nav-link').style.display = 'none';
              document.getElementById('revoke').removeAttribute("disabled");
              document.getElementById('edit').removeAttribute("disabled");
              $('.nav-tabs a[href="#citizen"]').tab('show');
              showModal("Publication success", "Your citizen card was published under number " + answer.citizen + ".<br>Check it at <a target='_blank' href='" + publisher + "/publication.php?id=" + answer.citizen + "'>" + publisher +
                "/publication.php?id=" + answer.citizen + "</a><br>");
            }
          }
        };
        xhttp.open("POST", publisher + "/publish.php", true);
        xhttp.send(JSON.stringify(citizen));
        return false;
      }

      function onUploadClick() {
        var upload = document.getElementById("picture-upload");
        upload.click();
      }

      function onPictureUploaded(event) {
        if (croppie) croppie.destroy();
        var img = document.getElementById("picture-display");
        img.src = URL.createObjectURL(event.target.files[0]);
        event.target.value = '';
        croppie = new Croppie(img, {
          boundary: {
            width: 250,
            height: 300
          },
          viewport: {
            width: 150,
            height: 200
          },
          enableExif: true
        });
        document.getElementById("picture-select").style.display = "";
      }

      function onPictureSelect() {
        croppie.result({
          type: 'base64',
          format: 'jpeg',
          quality: 0.95
        }).then(function(result) {
          var img = document.getElementById("picture-display");
          img.setAttribute('src', result);
          citizen.picture = result;
          document.getElementById("picture-select").style.display = "none";
          croppie.destroy();
          croppie = null;
          validate();
        });
      }

      function getGeolocationPosition(position) {
        geolocation = true;
        citizen.latitude = Math.round(1000000 * position.coords.latitude);
        citizen.longitude = Math.round(1000000 * position.coords.longitude);
        map.setView([position.coords.latitude, position.coords.longitude], 12);
        setTimeout(updateMarker, 500);
      }

      function updateMarker() {
        marker.setLatLng([citizen.latitude / 1000000, citizen.longitude / 1000000]);
        updateLocation();
      }

      function onMapClick(e) {
        marker.setLatLng(e.latlng);
        citizen.latitude = Math.round(1000000 * e.latlng.lat);
        citizen.longitude = Math.round(1000000 * e.latlng.lng);
        updateLocation();
      }

      function updateLocation() {
        var lat = citizen.latitude / 1000000;
        var lon = citizen.longitude / 1000000;
        marker.setPopupContent(lat + ',' + lon).openPopup();
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lon;
        validate();
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            a = JSON.parse(this.responseText);
            marker.setPopupContent(a.address.Match_addr + '<br><br><center style="color:#999">(' + lat + ', ' + lon + ')</center>').openPopup();
            document.getElementById("address").innerHTML = a.address.Match_addr;
          }
        };
        xhttp.open("GET", "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=json&featureTypes=&location=" + lon + "," + lat, true);
        xhttp.send();
      }

      function edit() {
        $('#modal-edit').modal();
      }

      function updateEditButton() {
        document.getElementById('edit-button').disabled = (document.getElementById('edit-i-understand').value != 'I understand');
      }

      function editCitizenCard() {
        document.getElementById('citizen-nav-link').style.display = 'none';
        document.getElementById('register-nav-link').style.display = '';
        document.getElementById('edit').setAttribute("disabled", "disabled");
        setupMap();
        $('.nav-tabs a[href="#register"]').tab('show');
        clearForms();
        $('#modal-edit').modal('hide');
        updateRegistrationForm();
      }

      function revoke() {
        $('#modal-revoke').modal();
      }

      function updateRevokeButton() {
        document.getElementById('revoke-button').disabled = (document.getElementById('revoke-i-understand').value != 'I understand');
      }

      function revokePrivateKey() {
        now = new Date();
        var endorsement = {
          schema: "https://directdemocracy.vote/json-schema/0.0.1/endorsement.schema.json",
          key: citizen.key,
          signature: "",
          published: now.toISOString(),
          expires: citizen.expires,
          revoke: true,
          publication: {
            key: citizen.key,
            signature: citizen.signature
          }
        };
        var str = JSON.stringify(endorsement);
        endorsement.signature = crypt.sign(str, CryptoJS.SHA256, "sha256");
        var xhttp = new XMLHttpRequest();
        xhttp.onload = function() {
          if (this.status == 200) {
            answer = JSON.parse(this.responseText);
            if (answer.error) {
              $('#modal-revoke').modal('hide');
              showModal("Revocation error", JSON.stringify(answer.error) + ".<br>Please try again.");
            } else {
              window.localStorage.removeItem("privateKey");
              generateNewKeyPair();
              localStorage.removeItem("citizen");
              localStorage.removeItem("publication");
              document.getElementById('citizen-nav-link').style.display = 'none';
              document.getElementById('register-nav-link').style.display = '';
              document.getElementById('edit').setAttribute("disabled", "disabled");
              document.getElementById('revoke').setAttribute("disabled", "disabled");
              setupMap();
              $('.nav-tabs a[href="#register"]').tab('show');
              clearForms();
              $('#modal-revoke').modal('hide');
              showModal("Revocation success", "Your private key was successfully revoked.");
              updateRegistrationForm();
            }
            document.getElementById('revoke-i-understand').value = '';
          }
        };
        xhttp.open("POST", publisher + "/publish.php", true);
        xhttp.send(JSON.stringify(endorsement));
      }

      function clearForms() {
        document.getElementById('edit-i-understand').value = '';
        document.getElementById('revoke-i-understand').value = '';
        document.getElementById('confirm-check').checked = false;
        document.getElementById("publish-button").setAttribute("disabled", "disabled");
        var d = new Date();
        d.setFullYear(d.getFullYear() + 10);
        var v = d.toISOString();
        document.getElementById("expiration").value = v.substring(0, 10);
      }

      function generateNewKeyPair() {
        privateKey = '';
        document.getElementById("forging-spinner").style.display = '';
        document.getElementById("private-key-icon").style.display = 'none';
        document.getElementById("private-key-message").innerHTML = "Forging a new private key, please wait...";
        var dt = new Date();
        var time = -(dt.getTime());
        crypt = new JSEncrypt({
          default_key_size: 2048
        });
        crypt.getKey(function() {
          dt = new Date();
          time += (dt.getTime());
          citizen.key = crypt.getPublicKey();
          privateKey = crypt.getPrivateKey();
          document.getElementById("forging-spinner").style.display = 'none';
          document.getElementById("private-key-icon").style.display = '';
          document.getElementById("private-key-message").innerHTML = "You new private key was just forged in " + Number(time / 1000).toFixed(2) + " seconds.";
          validate();
        });
      }

      function setupMap() {
        if (map != null) return;
        if (navigator.geolocation) navigator.geolocation.getCurrentPosition(getGeolocationPosition);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200 && geolocation == false) {
            coords = this.responseText.split(',');
            getGeolocationPosition({
              coords: {
                latitude: coords[0],
                longitude: coords[1]
              }
            });
          }
        };
        xhttp.open("GET", "https://ipinfo.io/loc", true);
        xhttp.send();
        var lat = citizen.latitude / 1000000;
        var lon = citizen.longitude / 1000000;
        map = L.map('latlongmap').setView([lat, lon], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        marker = L.marker([lat, lon]).addTo(map).bindPopup(lat + ',' + lon);
        updateLocation();
        map.on('click', onMapClick);
      }
      window.onload = function() {
        clearForms();
        $('.nav-tabs').on('shown.bs.tab', function(event) {
          if (map) map.invalidateSize();
        });
        publisher = localStorage.getItem("publisher");
        if (!publisher) publisher = "https://publisher.directdemocracy.vote";
        document.getElementById("publisher").value = publisher;
        privateKey = localStorage.getItem("privateKey");
        if (!privateKey) generateNewKeyPair();
        else {
          crypt = new JSEncrypt();
          crypt.setPrivateKey(privateKey);
          document.getElementById("forging-spinner").style.display = 'none';
          document.getElementById("private-key-icon").style.display = '';
          document.getElementById("private-key-message").innerHTML = "Using your existing private key.";
        }
        var citizen_string = localStorage.getItem("citizen");
        if (citizen_string) {
          citizen = JSON.parse(citizen_string);
          document.getElementById('register-nav-link').style.display = 'none';
          $('.nav-tabs a[href="#citizen"]').tab('show');
          updateCitizenCard();
        } else {
          document.getElementById('citizen-nav-link').style.display = 'none';
          document.getElementById('revoke').setAttribute("disabled", "disabled");
          document.getElementById('edit').setAttribute("disabled", "disabled");
          $('.nav-tabs a[href="#register"]').tab('show');
          citizen = {
            schema: "https://directdemocracy.vote/json-schema/0.0.1/citizen.schema.json",
            key: "",
            signature: "",
            published: "",
            expires: "",
            familyName: "",
            givenNames: "",
            picture: "",
            latitude: 0,
            longitude: 0
          };
          setupMap();
        }
      }

    </script>
  </body>

</html>
