<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="//directdemocracy.vote/favicon.ico">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.5.1/dist/leaflet.css">
    <link rel="stylesheet" href="css/croppie.css">
    <link rel="stylesheet" href="css/directdemocracy.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="//unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="js/croppie.min.js"></script>
    <script src="js/jsencrypt.min.js"></script>
    <script src="js/crypto-js.js"></script>
    <script src="js/country-code-3.js"></script>
    <script>
      window.onload = function() {
  let private_key = localStorage.getItem('privateKey');
  let publisher = localStorage.getItem('publisher');
  let trustee = localStorage.getItem('trustee');
  let latitude = 0;
  let longitude = 0;
  let address = '';
  if (private_key) {
    crypt = new JSEncrypt();
    crypt.setPrivateKey(private_key);
    let xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
      if (this.status == 200) {
        let answer = JSON.parse(this.responseText);
        if (answer.error)
          showModal('Coordinates error', JSON.stringify(answer.error) + '.<br>Please try again.');
        else
          updateArea(answer.latitude / 1000000, answer.longitude / 1000000);
      }
    };
    xhttp.open('POST', publisher + '/coordinates.php', true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.send('key=' + encodeURIComponent(crypt.getPublicKey()));
  }
  function updateArea(latitude, longitude) {
    let coordinates = document.getElementById('coordinates');
    coordinates.setAttribute('href', 'https://nominatim.openstreetmap.org/reverse.php?format=html&lat=' + latitude + '&lon=' + longitude);
    coordinates.innerHTML = latitude + ', ' + longitude;
    let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        const a = JSON.parse(this.responseText);
        address = a.address;
        console.log(address);
        let select = document.getElementById('area');
        let count = 0;
        function addAdminLevel(level) {
          if (level in address)
            select.options[count++] = new Option(address[level], level);
        }
        const admin = ['block', 'neighbourhood', 'quarter',
                      'suburb', 'borough',
                      'hamlet', 'village', 'town',
                      'city',
                      'municipality',
                      'county', 'district',
                      'region', 'province', 'state',
                      'country'];
        admin.forEach(function(item) {
          addAdminLevel(item);
        });
        const country_code = address.country_code.toUpperCase();
        if (['GB', 'DE', 'FR', 'IT', 'SE', 'PL', 'RO', 'HR', 'ES', 'NL', 'IE', 'BG', 'DK', 'GR',
             'AT', 'HU', 'FI', 'CZ', 'PT', 'BE', 'MT', 'CY', 'LU', 'SI', 'LU', 'SK', 'EE', 'LV']
            .indexOf(country_code) >= 0)
          select.options[count++] = new Option('European Union', 'union');
        select.options[count++] = new Option('Earth', 'world');
      }
    };
    xhttp.open('GET', 'https://nominatim.openstreetmap.org/reverse.php?format=json&lat=' + latitude + '&lon=' + longitude, true);
    xhttp.send();
  }
  document.getElementById('area').addEventListener('change', function(event) {
    let query = '';
    let first = event.target.options[event.target.selectedIndex].innerHTML;
    for(var i = event.target.selectedIndex; i < event.target.length - 1; i++)
      query += event.target.options[i].innerHTML + ', ';
    query = query.slice(0, -2);
    let coordinates = document.getElementById('coordinates');
    coordinates.href = 'https://nominatim.openstreetmap.org/search.php?q=' + encodeURI(query) + '&polygon_geojson=1&viewbox='; // FIXME
    coordinates.innerHTML = first;
  });
}
    </script>
    <title>directdemocracy.vote: propose a referundum</title>
  </head>

  <body>
    <div class="modal" id="modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="modal-title">Title</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body" id="modal-contents">Contents</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class='corner-ribbon' title="This web site is in beta quality: it may have bugs and change without notice. Please, report any problem to info@<?=$base_domain?>.">Beta</div>
    <main role='main'>
      <div class="jumbotron directdemocracy-title">
        <div class="container">
          <div class="row" style="margin-top:30px;margin-bottom:30px">
            <div class="col-sd-1" style="margin-right:20px;margin-top:10px"><img class="directdemocracy-title-logo" src="images/directdemocracy-title.png"></div>
            <div class="col-sd-11">
              <h1><b>direct</b>democracy</h1>
              <div style="font-size:150%">propose a referendum</div>
            </div>
          </div>
          <div class="directdemocracy-subtitle" style="position:relative;top:0;margin-bottom:40px">
            <h3>- write a referendum</h3>
            <h3>- publish it and advertise it</h3>
            <h3>- get the results of the votes</h3>
          </div>
          <div><br></div>
        </div>
      </div>
      <div class="container">
        <div class="form-group">
          <label for="title">Title:</label>
          <input type="text" class="form-control" id="title" placeholder="Enter the title of your referendum" required>
        </div>
        <div class="form-group">
          <label for="title">Description:</label>
          <textarea class="form-control" id="description" placeholder="Enter the description of your referendum" rows="5" required></textarea>
          <small class="form-text text-muted">You may use simple text or <a target="_blank" href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> format here.</small>
        </div>
        <div class="form-group">
          <label for="title">Question:</label>
          <input type="text" class="form-control" id="question" placeholder="Enter the question that citizens should answer" required>
        </div>
        <div class="form-group">
          <label for="title">Possible Answers:</label>
          <input type="text" class="form-control" id="answers" placeholder="Enter a comma-separated list of possible answers, e.g., Yes, No, Abstain" required>
        </div>
        <div class="form-group">
          <label for="title">Vote Deadline:</label>
          <input class="form-control" type="date" id="deadline" required>
        </div>
        <div class="form-group">
          <label for="title">Area: <a id="coordinates" target="_blank"></a></label>
          <select class="form-control" id="area">
            <option>Areas are computed automatically from your GPS coordinates</option>
          </select>
        </div>
        <div class="form-group">
          <label for="title">Web Site: (optional)</label>
          <input type="url" class="form-control" id="website" placeholder="Enter the website URL of your referendum if any, e.g., https://myreferendum.net">
        </div>
      </div>
    </main>
    <div>
      <hr>
      <footer>
        <p style="text-align:center"><small>Made by citizens for citizens</small></p>
      </footer>
    </div>
  </body>

</html>
